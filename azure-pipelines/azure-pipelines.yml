trigger:
- master

pool:
  vmImage: 'ubuntu-16.04'

variables:
  buildConfiguration: 'Release'
  
stages:
- stage: QA
  jobs:
  - job: API
    steps:

    - task: UseDotNet@2
      displayName: 'Install .NET Core sdk'
      inputs:
        packageType: sdk
        version: 2.1.301
        installationPath: $(Agent.ToolsDirectory)/dotnet

    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: 'build'
        arguments: '--configuration $(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: Test
      inputs:
        command: test
        projects: '**/MyHelper.Tests.Unit/*.csproj'
        arguments: '--configuration $(buildConfiguration)'
  
  - job: ClientApp
    steps:

      - task: NodeTool@0
        displayName: 'Install Node.js'
        inputs:
          versionSpec: '10.15.1'

      - task: Npm@1
        displayName: 'Npm install'
        inputs:
          command: install
          workingDir: 'MyHelper.ClientApp'

      - task: Npm@1
        displayName: 'Build Angular'
        inputs:
          command: custom
          customCommand: run build
          workingDir: 'MyHelper.ClientApp'

      - task: Npm@1
        displayName: 'Test Angular'
        inputs:
          command: custom
          customCommand: run test -- --watch=false
          workingDir: 'MyHelper.ClientApp'

      - task: PublishTestResults@2
        displayName: 'Publish Angular test results'
        condition: succeededOrFailed()
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: 'MyHelper.ClientApp/junit-tests'
          testRunTitle: 'Angular'